<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="John Bogovic">
<meta name="dcterms.date" content="2024-02-14">
<meta name="description" content="Create and apply non-linear transformations with Imglib2.">

<title>ImgLib2 news and tutorials - Position and displacement field transformations</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="ImgLib2 news and tutorials - Position and displacement field transformations">
<meta property="og:description" content="Create and apply non-linear transformations with Imglib2.">
<meta property="og:image" content="https://imglib.github.io/imglib2-blog/posts/2024-02-14-displacementFields/imglib2-logo.png">
<meta property="og:site_name" content="ImgLib2 news and tutorials">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../imglib2-logo-header.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">ImgLib2 news and tutorials</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">ImgLib2</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/imglib"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://fosstodon.org/@imglib2"> <i class="bi bi-mastodon" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Position and displacement field transformations</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button" data-quarto-source-url="https://github.com/imglib/imglib2-blog/blob/main/posts/2024-02-14-displacementFields/2024-02-14-displacementFields.ipynb">View Source</a></li></ul></div></div>
                  <div>
        <div class="description">
          Create and apply non-linear transformations with Imglib2.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">imglib2</div>
                <div class="quarto-category">transform</div>
                <div class="quarto-category">deformation</div>
                <div class="quarto-category">displacement</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>John Bogovic </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 14, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>This post shows how to create and apply non-linear transformations with Imglib2, specifically using <a href="https://github.com/imglib/imglib2-realtransform/blob/imglib2-realtransform-4.0.1/src/main/java/net/imglib2/realtransform/DisplacementFieldTransform.java#L61"><code>DisplacementFieldTransform</code></a>s and <a href="https://github.com/imglib/imglib2-realtransform/blob/imglib2-realtransform-4.0.1/src/main/java/net/imglib2/realtransform/PositionFieldTransform.java#L64"><code>PositionFieldTransform</code></a>s.</p>
<p>The last example of this post will show how to use a <code>PositionFieldTransform</code> to create a 2D image from a 1D signal by a transformation of coordinates.</p>
<table class="table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">A 2D image created after transformation</th>
<th style="text-align: center;">of this 1D function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><img src="shellFromPfield.png" title="The 2D image" class="img-fluid" alt="The 2D image"></td>
<td style="text-align: center;"><img src="function1d.png" title="A 1D Function" class="img-fluid" alt="A 1D function"></td>
</tr>
</tbody>
</table>
<p>The code folded below sets up dependencies, imports classes, and makes it convenient to show image output as shown in <a href="https://imglib.github.io/imglib2-blog/posts/2022-09-04-how-to-display-imglib2-data.html">this post</a>.</p>
<div id="2bfbf11f" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>mavenRepo scijava<span class="op">.</span><span class="fu">public</span> https<span class="op">:</span><span class="co">//maven.scijava.org/content/groups/public</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>maven net<span class="op">.</span><span class="fu">imagej</span><span class="op">:</span>ij<span class="op">:</span><span class="fl">1.54f</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>maven org<span class="op">.</span><span class="fu">scijava</span><span class="op">:</span>scijava<span class="op">-</span>common<span class="op">:</span><span class="fl">2.97.0</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>maven net<span class="op">.</span><span class="fu">imglib2</span><span class="op">:</span>imglib2<span class="op">:</span><span class="fl">6.2.0</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>maven net<span class="op">.</span><span class="fu">imglib2</span><span class="op">:</span>imglib2<span class="op">-</span>ij<span class="op">:</span><span class="fl">2.0.1</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>maven net<span class="op">.</span><span class="fu">imglib2</span><span class="op">:</span>imglib2<span class="op">-</span>realtransform<span class="op">:</span><span class="fl">4.0.1</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>maven org<span class="op">.</span><span class="fu">knowm</span><span class="op">.</span><span class="fu">xchart</span><span class="op">:</span>xchart<span class="op">:</span><span class="fl">3.5.4</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">function</span><span class="op">.*;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">stream</span><span class="op">.*;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">awt</span><span class="op">.</span><span class="im">image</span><span class="op">.</span><span class="im">BufferedImage</span><span class="op">;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">io</span><span class="op">.</span><span class="im">github</span><span class="op">.</span><span class="im">spencerpark</span><span class="op">.</span><span class="im">jupyter</span><span class="op">.</span><span class="im">kernel</span><span class="op">.</span><span class="im">display</span><span class="op">.</span><span class="im">common</span><span class="op">.*;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">io</span><span class="op">.</span><span class="im">github</span><span class="op">.</span><span class="im">spencerpark</span><span class="op">.</span><span class="im">jupyter</span><span class="op">.</span><span class="im">kernel</span><span class="op">.</span><span class="im">display</span><span class="op">.</span><span class="im">mime</span><span class="op">.*;</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">knowm</span><span class="op">.</span><span class="im">xchart</span><span class="op">.*;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">knowm</span><span class="op">.</span><span class="im">xchart</span><span class="op">.</span><span class="im">style</span><span class="op">.</span><span class="im">Styler</span><span class="op">.</span><span class="im">LegendPosition</span><span class="op">;</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">knowm</span><span class="op">.</span><span class="im">xchart</span><span class="op">.</span><span class="im">style</span><span class="op">.</span><span class="im">markers</span><span class="op">.</span><span class="im">SeriesMarkers</span><span class="op">;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">ij</span><span class="op">.*;</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.*;</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.</span><span class="im">view</span><span class="op">.*;</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.</span><span class="im">util</span><span class="op">.*;</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.</span><span class="im">realtransform</span><span class="op">.*;</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.</span><span class="im">position</span><span class="op">.*;</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.</span><span class="im">type</span><span class="op">.</span><span class="im">numeric</span><span class="op">.*;</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.</span><span class="im">type</span><span class="op">.</span><span class="im">numeric</span><span class="op">.</span><span class="im">real</span><span class="op">.*;</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.</span><span class="im">type</span><span class="op">.</span><span class="im">numeric</span><span class="op">.</span><span class="im">integer</span><span class="op">.*;</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.</span><span class="im">interpolation</span><span class="op">.</span><span class="im">randomaccess</span><span class="op">.*;</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.</span><span class="im">img</span><span class="op">.</span><span class="im">display</span><span class="op">.</span><span class="im">imagej</span><span class="op">.*;</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.</span><span class="im">img</span><span class="op">.</span><span class="im">imageplus</span><span class="op">.</span><span class="im">ImagePlusImgs</span><span class="op">;</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.</span><span class="im">img</span><span class="op">.</span><span class="im">array</span><span class="op">.</span><span class="im">ArrayImgs</span><span class="op">;</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="op">&lt;</span>T <span class="kw">extends</span> NumericType<span class="op">&lt;</span>T<span class="op">&gt;&gt;</span> <span class="bu">BufferedImage</span> <span class="fu">toBuffferedImage</span><span class="op">(</span>RandomAccessibleInterval rai<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ImageJFunctions<span class="op">.</span><span class="fu">wrap</span><span class="op">((</span>RandomAccessibleInterval<span class="op">&lt;</span>T<span class="op">&gt;)</span>rai<span class="op">,</span> <span class="st">""</span><span class="op">).</span><span class="fu">getBufferedImage</span><span class="op">();</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="fu">getKernelInstance</span><span class="op">().</span><span class="fu">getRenderer</span><span class="op">().</span><span class="fu">createRegistration</span><span class="op">(</span>RandomAccessibleInterval<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">preferring</span><span class="op">(</span>MIMEType<span class="op">.</span><span class="fu">IMAGE_PNG</span><span class="op">)</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">supporting</span><span class="op">(</span>MIMEType<span class="op">.</span><span class="fu">IMAGE_JPEG</span><span class="op">,</span> MIMEType<span class="op">.</span><span class="fu">IMAGE_GIF</span><span class="op">)</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">register</span><span class="op">((</span>rai<span class="op">,</span> context<span class="op">)</span> <span class="op">-&gt;</span> <span class="bu">Image</span><span class="op">.</span><span class="fu">renderImage</span><span class="op">(</span><span class="fu">toBuffferedImage</span><span class="op">(</span>rai<span class="op">),</span>context<span class="op">));</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> printWriter <span class="op">=</span> <span class="kw">new</span> <span class="bu">PrintWriter</span><span class="op">(</span><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">,</span><span class="kw">true</span><span class="op">);</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> rarrow <span class="op">=</span> <span class="ch">'\u2192'</span><span class="op">;</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">printTformPts</span><span class="op">(</span>RealPoint x<span class="op">,</span> RealPoint y<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>    printWriter<span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="bu">String</span><span class="op">.</span><span class="fu">format</span><span class="op">(</span><span class="st">"</span><span class="sc">%s</span><span class="st"> </span><span class="sc">%s</span><span class="st"> </span><span class="sc">%s</span><span class="st">"</span><span class="op">,</span> x<span class="op">,</span> rarrow<span class="op">,</span> y<span class="op">));</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="displacement-fields" class="level1">
<h1>Displacement fields</h1>
<p>A displacement field is the most common way to represent and store non-linear transformations. Imagine an image where a vector is stored at every position <span class="math inline">\(\mathbf{x}\)</span>. That vector describes how much and in what direction the position <span class="math inline">\(\mathbf{x}\)</span> should be translated, or displaced.</p>
<p><span class="math display">\[
\begin{align}
\mathbf{x} &amp;: \text{a position } \\
\mathbf{v}( \mathbf{x} ) &amp;: \text{the vector at position } \mathbf{x}\\
\mathbf{x} + \mathbf{v}( \mathbf{x} ) &amp;: \text{the output of the transformation}
\end{align}
\]</span></p>
<p>For example, let’s consider an example vector field with the vector <span class="math inline">\([50, -25]\)</span> at every position. This will be equivalent to a simple global translation and is not <a href="https://javadoc.scijava.org/ImgLib2/net/imglib2/realtransform/Translation.html">the recommended way to represent a translation</a>, but will be instructive thanks to its simplicity.</p>
<p>A <a href="https://javadoc.scijava.org/ImgLib2/net/imglib2/position/FunctionRealRandomAccessible.html"><code>FunctionRealRandomAccessible</code></a> is one way to make a image containing a constant value (<a href="https://javadoc.scijava.org/ImgLib2/net/imglib2/util/ConstantUtils.html"><code>ConstantUtils</code></a> is another way). This image can be passed directly to a <code>DisplacementFieldTransform</code>.</p>
<div id="17d8f146" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> displacementVector <span class="op">=</span> <span class="kw">new</span> <span class="dt">double</span><span class="op">[]{</span><span class="dv">50</span><span class="op">,</span> <span class="op">-</span><span class="dv">25</span><span class="op">};</span>        <span class="co">// the constant vector</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">// an image that takes the value of displacementVector everywhere</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> constantVector <span class="op">=</span> <span class="kw">new</span> FunctionRealRandomAccessible<span class="op">&lt;&gt;(</span><span class="dv">2</span><span class="op">,</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span>x<span class="op">,</span> v<span class="op">)</span> <span class="op">-&gt;</span> <span class="op">{</span> v<span class="op">.</span><span class="fu">setPosition</span><span class="op">(</span>displacementVector<span class="op">);</span> <span class="op">},</span> <span class="co">// set the vector </span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">()</span> <span class="op">-&gt;</span> <span class="op">{</span> <span class="cf">return</span> DoubleType<span class="op">.</span><span class="fu">createVector</span><span class="op">(</span><span class="dv">2</span><span class="op">);</span> <span class="op">});</span>     <span class="co">// make a 2d vector</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">// a constant displacement field</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> dfieldConstant <span class="op">=</span> <span class="kw">new</span> <span class="fu">DisplacementFieldTransform</span><span class="op">(</span>constantVector<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Applying the transformation to any point translates that point by the same amount <span class="math inline">\([50, -25]\)</span> , as expected:</p>
<div id="53fb97b8" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// two ways of initializing a point (0.0, 0.0)</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span> <span class="co">// give the coordinates as arguments</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> y <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span><span class="dv">2</span><span class="op">);</span>        <span class="co">// give the number of dimensions as an argument</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">// transform x, store the result in y</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>dfieldConstant<span class="op">.</span><span class="fu">apply</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a> <span class="co">// [0, 0] is transformed to [50, -25]</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">// [-50, 25] is transformed to [0, 0]</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(-</span><span class="dv">50</span><span class="op">,</span> <span class="dv">25</span><span class="op">);</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>dfieldConstant<span class="op">.</span><span class="fu">apply</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">// [pi, 100k] is transformed to [pi + 50, 100k - 25]</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span><span class="bu">Math</span><span class="op">.</span><span class="fu">PI</span><span class="op">,</span> <span class="dv">100000</span><span class="op">);</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>dfieldConstant<span class="op">.</span><span class="fu">apply</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(0.0,0.0) → (50.0,-25.0)
(-50.0,25.0) → (0.0,0.0)
(3.141592653589793,100000.0) → (53.1415926535898,99975.0)</code></pre>
</div>
</div>
<p>Let’s make a slightly more interesting displacement field with four vectors - one at each corner. Our image will be:</p>
<pre><code>----------------
|[1, 1]  [2, 2]|
|[3, 3]  [4, 4]|
----------------</code></pre>
<p>i.e.&nbsp;the vector at position (0,1) is <span class="math inline">\([3,3]\)</span>.</p>
<p>Our data needs to be 3D, where the first dimension holds the two vector components, and the other two hold the spatial dimensions. We can use an <a href="https://javadoc.scijava.org/ImgLib2/net/imglib2/img/array/ArrayImg.html"><code>ArrayImg</code></a> to store these data.</p>
<div id="f27c0a5a" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> dfieldData <span class="op">=</span> ArrayImgs<span class="op">.</span><span class="fu">doubles</span><span class="op">(</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="dt">double</span><span class="op">[]{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">4</span><span class="op">},</span> <span class="co">// the data</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        <span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">);</span>  <span class="co">// the dimensions</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">// the displacement field</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> dfieldCorners <span class="op">=</span> <span class="kw">new</span> <span class="fu">DisplacementFieldTransform</span><span class="op">(</span>dfieldData<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>For example, we expect the transformation to take the point <span class="math inline">\([0,1]\)</span> to <span class="math inline">\([3,4] = [0,1] + [3,3]\)</span>, and that is indeed what we see:</p>
<div id="abba1f19" class="cell" data-execution_count="5">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// [0,0] is transformed to [1,1] = [0,0] + [1,1]</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> y <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>dfieldCorners<span class="op">.</span><span class="fu">apply</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">// [1,0] is transformed to [3,2] = [1,0] + [2,2]</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>dfieldCorners<span class="op">.</span><span class="fu">apply</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">// [0,1] is transformed to [3,4] = [0,1] + [3,3]</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>dfieldCorners<span class="op">.</span><span class="fu">apply</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co">// [1,1] is transformed to [5,5] = [1,1] + [4,4]</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>dfieldCorners<span class="op">.</span><span class="fu">apply</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(0.0,0.0) → (1.0,1.0)
(1.0,0.0) → (3.0,2.0)
(0.0,1.0) → (3.0,4.0)
(1.0,1.0) → (5.0,5.0)</code></pre>
</div>
</div>
<p>What happens if we try to apply the transformation “in between” the discrete values of the array, or out-of-bounds of the array?</p>
<div id="892265ed" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// [0.5, 0.5] is transformed to [3.0, 3.0]</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span><span class="fl">0.5</span><span class="op">,</span> <span class="fl">0.5</span><span class="op">);</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> y <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>dfieldCorners<span class="op">.</span><span class="fu">apply</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">// [-100, -100] is transformed to [-99.0,-99.0]</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(-</span><span class="dv">100</span><span class="op">,</span> <span class="op">-</span><span class="dv">100</span><span class="op">);</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>dfieldCorners<span class="op">.</span><span class="fu">apply</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(0.5,0.5) → (3.0,3.0)
(-100.0,-100.0) → (-99.0,-99.0)</code></pre>
</div>
</div>
<p>By default, linear interpolation determines the displacement within the array but off of grid values. The nearest value on the border of the array determines the displacement outside the array’s bounds. If, instead, we want nearest-neighbor interpolation and all out-of-bounds displacements to be zero, it can be acheived by:</p>
<div id="654d9c3b" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">// interpret our 3d image as a 2d image of vectors</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> vectorsFrom3D <span class="op">=</span> Views<span class="op">.</span><span class="fu">collapseReal</span><span class="op">(</span>Views<span class="op">.</span><span class="fu">moveAxis</span><span class="op">(</span>dfieldData<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> dfieldData<span class="op">.</span><span class="fu">numDimensions</span><span class="op">()</span> <span class="op">-</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">// make the displacement field with custom interpolation and boundary extension</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> dfieldCornersCustom <span class="op">=</span> <span class="kw">new</span> <span class="fu">DisplacementFieldTransform</span><span class="op">(</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        Views<span class="op">.</span><span class="fu">interpolate</span><span class="op">(</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>                Views<span class="op">.</span><span class="fu">extendZero</span><span class="op">(</span>vectorsFrom3D<span class="op">),</span>            <span class="co">// zeros out-of-bounds</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>                <span class="kw">new</span> <span class="fu">NearestNeighborInterpolatorFactory</span><span class="op">()));</span> <span class="co">// nearest-neighbor interpolation</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co">// [0.4, 0.4] is transformed to [1.4, 1.4]</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span><span class="fl">0.4</span><span class="op">,</span> <span class="fl">0.4</span><span class="op">);</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> y <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>dfieldCornersCustom<span class="op">.</span><span class="fu">apply</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co">// [-100, -100] is transformed to [-100, -100]</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(-</span><span class="dv">100</span><span class="op">,</span> <span class="op">-</span><span class="dv">100</span><span class="op">);</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>dfieldCornersCustom<span class="op">.</span><span class="fu">apply</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(0.4,0.4) → (1.4,1.4)
(-100.0,-100.0) → (-100.0,-100.0)</code></pre>
</div>
</div>
<p>Another common requirement is to specify the spacing and offset of the displacement field’s discrete grid. For example, suppose we want the displacements above to be applied to the field of view <span class="math inline">\([-10, 10] \times [-20, 20]\)</span> rather than the array coordinates <span class="math inline">\([0, 1] \times [0, 1]\)</span>.</p>
<pre><code>(-10,-20)  ------------------------------------------------  (10,-20)
           |[1,1]                                    [2,2]|
           |                                              |                                          
           |                                              |
           |                                              |
           |            (interpolated values)             |
           |                                              |
           |                                              |
           |                                              |
           |[3,3]                                    [4,4]|
(-10, 20)  ------------------------------------------------ (10,20)               </code></pre>
<p>where the values outside the box in parenthesis are the coordinates of the corners.</p>
<p>This is possible by passing the desired spacing and offset directly to the <code>DisplacementFieldTransform</code>.</p>
<div id="d824bbee" class="cell" data-execution_count="8">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * the spacing and offset below map the array origin [0,0] to [-10,-20]</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * and the element at array index [1,1] to [10,20]</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> spacing <span class="op">=</span> <span class="kw">new</span> <span class="dt">double</span><span class="op">[]{</span><span class="dv">20</span><span class="op">,</span> <span class="dv">40</span><span class="op">};</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> offset <span class="op">=</span> <span class="kw">new</span> <span class="dt">double</span><span class="op">[]{-</span><span class="dv">10</span><span class="op">,</span> <span class="op">-</span><span class="dv">20</span><span class="op">};</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> dfieldCornersSpacingOffset <span class="op">=</span> <span class="kw">new</span> <span class="fu">DisplacementFieldTransform</span><span class="op">(</span>dfieldData<span class="op">,</span> spacing<span class="op">,</span> offset<span class="op">);</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">// [-10,-20] is displaced by the vector [1,1], so goes to [-9,-19]</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(-</span><span class="dv">10</span><span class="op">,</span> <span class="op">-</span><span class="dv">20</span><span class="op">);</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> y <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>dfieldCornersSpacingOffset<span class="op">.</span><span class="fu">apply</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co">// similarly, [10,20] is displaced by the vector [4,4], so goes to [14,24]</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span><span class="dv">10</span><span class="op">,</span> <span class="dv">20</span><span class="op">);</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>dfieldCornersSpacingOffset<span class="op">.</span><span class="fu">apply</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(-10.0,-20.0) → (-9.0,-19.0)
(10.0,20.0) → (14.0,24.0)</code></pre>
</div>
</div>
</section>
<section id="transforming-images" class="level1">
<h1>Transforming images</h1>
<p>Displacement fields can also be applied to images. First, let’s open an image:</p>
<div id="be509886" class="cell" data-execution_count="9">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> img <span class="op">=</span> ImageJFunctions<span class="op">.</span><span class="fu">wrap</span><span class="op">(</span>IJ<span class="op">.</span><span class="fu">openImage</span><span class="op">(</span><span class="st">"https://mirror.imagej.net/ij/images/boats.gif"</span><span class="op">));</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>img</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>
<figure class="figure">
<p><img src="2024-02-14-displacementFields_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Now let’s transform it using our constant valued displacement field. Remember this field has the vector <span class="math inline">\([50, -25]\)</span> everwhere.</p>
<p>First, we’ll define two functions for transforming images:</p>
<div id="099a5563" class="cell" data-execution_count="10">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Transform an image of arbitrary size (RandomAccessible) and output an image of size</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * given by resultInterval.</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span> </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> RandomAccessibleInterval <span class="fu">transformImageInterval</span><span class="op">(</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        RandomAccessible img<span class="op">,</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        RealTransform transform<span class="op">,</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        Interval resultInterval<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// use n-linear interpolation</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> interpImg <span class="op">=</span> Views<span class="op">.</span><span class="fu">interpolate</span><span class="op">(</span>img<span class="op">,</span> <span class="kw">new</span> <span class="fu">NLinearInterpolatorFactory</span><span class="op">());</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// transform the image</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> transformedImg <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealTransformRandomAccessible</span><span class="op">(</span>interpImg<span class="op">,</span> transform<span class="op">);</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// rasterize and set bounding box</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Views<span class="op">.</span><span class="fu">interval</span><span class="op">(</span>Views<span class="op">.</span><span class="fu">raster</span><span class="op">(</span>transformedImg<span class="op">),</span> resultInterval<span class="op">);</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> RandomAccessibleInterval <span class="fu">transformImage</span><span class="op">(</span>RandomAccessibleInterval img<span class="op">,</span> RealTransform transform<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// default out-of-bounds extension and output interval</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">transformImageInterval</span><span class="op">(</span>Views<span class="op">.</span><span class="fu">extendZero</span><span class="op">(</span>img<span class="op">),</span> transform<span class="op">,</span> img<span class="op">);</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="fu">transformImage</span><span class="op">(</span>img<span class="op">,</span> dfieldConstant<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>
<figure class="figure">
<p><img src="2024-02-14-displacementFields_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Notice that the image is shifted down (+y direction) and to the left (-x direction) : the opposite direction of the displacement vector. This is because the “inverse” transformation (from output coordinates to input coordinates) is needed to transform images. <a href="https://github.com/bogovicj/transforms_tutorial/blob/master/resources/2019_DAIS.pdf">Learn why here</a>.</p>
<p>Now let’s use what we learned above to make a displacement field whose corners are the corners of the image. We do this by setting the spacing of the displacement field’s coordinate grid as we learned above. This means displacement vector stored at at the array coordinate <code>[1,1]</code> to a new position: <code>[imageWidth, imageHeight]</code>.</p>
<div id="ba9d3611" class="cell" data-execution_count="11">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">// some vector field</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> dfieldData <span class="op">=</span> ArrayImgs<span class="op">.</span><span class="fu">doubles</span><span class="op">(</span> </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="dt">double</span><span class="op">[]{-</span><span class="dv">45</span><span class="op">,</span> <span class="op">-</span><span class="dv">50</span><span class="op">,</span> <span class="dv">35</span><span class="op">,</span> <span class="op">-</span><span class="dv">35</span><span class="op">,</span> <span class="op">-</span><span class="dv">25</span><span class="op">,</span> <span class="dv">25</span><span class="op">,</span> <span class="dv">70</span><span class="op">,</span> <span class="dv">75</span><span class="op">},</span>  <span class="co">// the vector data</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>        <span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">);</span> <span class="co">// the dimensions</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">// use the image width and height as the vector fields spacing</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> dfield <span class="op">=</span> <span class="kw">new</span> <span class="fu">DisplacementFieldTransform</span><span class="op">(</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        dfieldData<span class="op">,</span> </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        img<span class="op">.</span><span class="fu">dimension</span><span class="op">(</span><span class="dv">0</span><span class="op">),</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        img<span class="op">.</span><span class="fu">dimension</span><span class="op">(</span><span class="dv">1</span><span class="op">));</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co">// transform the image</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="fu">transformImage</span><span class="op">(</span>img<span class="op">,</span> dfield<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>
<figure class="figure">
<p><img src="2024-02-14-displacementFields_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Finally, let’s make a field of random displacements at one-tenth the resolution of the image and apply it.</p>
<div id="f36ffbdf" class="cell" data-execution_count="12">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">// create image of random vectors</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> randDfieldData <span class="op">=</span> ArrayImgs<span class="op">.</span><span class="fu">doubles</span><span class="op">(</span><span class="dv">2</span><span class="op">,</span> <span class="op">(</span>img<span class="op">.</span><span class="fu">dimension</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">/</span> <span class="dv">20</span><span class="op">),</span> <span class="op">(</span>img<span class="op">.</span><span class="fu">dimension</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">/</span> <span class="dv">20</span><span class="op">));</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>randDfieldData<span class="op">.</span><span class="fu">forEach</span><span class="op">(</span>x <span class="op">-&gt;</span> <span class="op">{</span>x<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="dv">15</span> <span class="op">*</span> <span class="op">(</span><span class="bu">Math</span><span class="op">.</span><span class="fu">random</span><span class="op">()</span> <span class="op">-</span> <span class="fl">0.5</span><span class="op">));});</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">// spacing of 20</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> dfield <span class="op">=</span> <span class="kw">new</span> <span class="fu">DisplacementFieldTransform</span><span class="op">(</span>randDfieldData<span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">20</span><span class="op">);</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">// transform the image</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="fu">transformImage</span><span class="op">(</span>img<span class="op">,</span> dfield<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>
<figure class="figure">
<p><img src="2024-02-14-displacementFields_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="position-fields" class="level1">
<h1>Position fields</h1>
<p>A position, or coordinate field is similar to a displacement field in that it is also represented by a field of vectors, but those vectors represent positions directly, rather than displacements of the current position.</p>
<p><span class="math display">\[
\begin{align}
\mathbf{x} &amp;: \text{a position } \\
\mathbf{v}( \mathbf{x} ) &amp;: \text{the vector at position } \mathbf{x}\\
\mathbf{v}( \mathbf{x} ) &amp;: \text{the output of the transformation}
\end{align}
\]</span></p>
<p>If we use a constant vector field to make a <code>PositionFieldTransform</code> the output will always be the same:</p>
<div id="cf978c79" class="cell" data-execution_count="13">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> coordinateVector <span class="op">=</span> <span class="kw">new</span> <span class="dt">double</span><span class="op">[]{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">};</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> constantVector <span class="op">=</span> <span class="kw">new</span> FunctionRealRandomAccessible<span class="op">&lt;&gt;(</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>        <span class="dv">2</span><span class="op">,</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span>x<span class="op">,</span> v<span class="op">)</span> <span class="op">-&gt;</span> <span class="op">{</span>v<span class="op">.</span><span class="fu">setPosition</span><span class="op">(</span> coordinateVector <span class="op">);},</span>  <span class="co">// set the vector </span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">()</span> <span class="op">-&gt;</span> <span class="op">{</span><span class="cf">return</span> DoubleType<span class="op">.</span><span class="fu">createVector</span><span class="op">(</span><span class="dv">2</span><span class="op">);});</span>     <span class="co">// make a 2d vector</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> pfieldConstant <span class="op">=</span> <span class="kw">new</span> <span class="fu">PositionFieldTransform</span><span class="op">(</span>constantVector<span class="op">);</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co">// [0, 0] is transformed to [1, 2]</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> y <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>pfieldConstant<span class="op">.</span><span class="fu">apply</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co">// [9999, 9999] is also transformed to [1, 2]</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span><span class="dv">9999</span><span class="op">,</span> <span class="dv">9999</span><span class="op">);</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> y <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>pfieldConstant<span class="op">.</span><span class="fu">apply</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(0.0,0.0) → (1.0,2.0)
(9999.0,9999.0) → (1.0,2.0)</code></pre>
</div>
</div>
<p>The <a href="https://javadoc.scijava.org/ImgLib2/net/imglib2/util/Localizables.html"><code>Localizables</code></a> class has some convenience methods for producing images of coordinates. Creating a position field with this image gives the identity. <a href="https://javadoc.scijava.org/ImgLib2/net/imglib2/position/FunctionRandomAccessible.html"><code>FunctionRandomAccessible</code></a>s can also be used to generate coordinate images.</p>
<p><em>Challenge:</em> Try using <a href="https://javadoc.scijava.org/ImgLib2/net/imglib2/converter/Converters.html"><code>Converters</code></a> to extract the x and y coordinates from the <code>coordinates</code> variable.</p>
<div id="0c9d92bd" class="cell" data-execution_count="14">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">// make an image of coordinates. The argument "2" specifies the number of dimensions.</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> coordinates <span class="op">=</span> Localizables<span class="op">.</span><span class="fu">realRandomAccessible</span><span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">// make an image whose intensities are the x coordinate</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> xCoordinates <span class="op">=</span> Views<span class="op">.</span><span class="fu">interval</span><span class="op">(</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> FunctionRandomAccessible<span class="op">&lt;&gt;(</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>                <span class="dv">2</span><span class="op">,</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>                <span class="op">(</span>x<span class="op">,</span> v<span class="op">)</span> <span class="op">-&gt;</span> <span class="op">{</span>v<span class="op">.</span><span class="fu">set</span><span class="op">(</span>x<span class="op">.</span><span class="fu">getIntPosition</span><span class="op">(</span><span class="dv">0</span><span class="op">));},</span> </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>                UnsignedByteType<span class="op">::</span><span class="kw">new</span><span class="op">),</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="fu">FinalInterval</span><span class="op">(</span><span class="dv">255</span><span class="op">,</span> <span class="dv">255</span><span class="op">));</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="co">// make an image whose intensities are the x coordinate</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> yCoordinates <span class="op">=</span> Views<span class="op">.</span><span class="fu">interval</span><span class="op">(</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> FunctionRandomAccessible<span class="op">&lt;&gt;(</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>                <span class="dv">2</span><span class="op">,</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>                <span class="op">(</span>x<span class="op">,</span> v<span class="op">)</span> <span class="op">-&gt;</span> <span class="op">{</span>v<span class="op">.</span><span class="fu">set</span><span class="op">(</span>x<span class="op">.</span><span class="fu">getIntPosition</span><span class="op">(</span><span class="dv">1</span><span class="op">));},</span> </span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>                UnsignedByteType<span class="op">::</span><span class="kw">new</span><span class="op">),</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="fu">FinalInterval</span><span class="op">(</span><span class="dv">255</span><span class="op">,</span> <span class="dv">255</span><span class="op">));</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span><span class="op">(</span><span class="st">"x coordinates"</span><span class="op">);</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span><span class="op">(</span>xCoordinates <span class="op">);</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span><span class="op">(</span><span class="st">" "</span><span class="op">);</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span><span class="op">(</span><span class="st">"y coordinates"</span><span class="op">);</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>yCoordinates</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>x coordinates</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2024-02-14-displacementFields_files/figure-html/cell-15-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<pre><code> </code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>y coordinates</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>
<figure class="figure">
<p><img src="2024-02-14-displacementFields_files/figure-html/cell-15-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="34c6f93d" class="cell" data-execution_count="15">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">// the identity transformation</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> identityPfield <span class="op">=</span> <span class="kw">new</span> <span class="fu">PositionFieldTransform</span><span class="op">(</span>Localizables<span class="op">.</span><span class="fu">realRandomAccessible</span><span class="op">(</span><span class="dv">2</span><span class="op">));</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co">// [0, 0] is transformed to [0, 0]</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> y <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>identityPfield<span class="op">.</span><span class="fu">apply</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="co">// [9999, 9999] is transformed to [9999, 9999]</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span><span class="dv">9999</span><span class="op">,</span> <span class="dv">9999</span><span class="op">);</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>identityPfield<span class="op">.</span><span class="fu">apply</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(0.0,0.0) → (0.0,0.0)
(9999.0,9999.0) → (9999.0,9999.0)</code></pre>
</div>
</div>
<p>For the above examples, notice that the <code>identityPfield</code> does indeed behaves as the identity transformation.</p>
<p>Let’s make another position field that stretches and compresses the image in a non-linear way.</p>
<div id="a41cf2d8" class="cell" data-execution_count="16">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * The details of this vector field are not so important,</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * but notice that it is some non-linear function.</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span> </span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> pFieldVectorField <span class="op">=</span> <span class="kw">new</span> FunctionRealRandomAccessible<span class="op">&lt;&gt;(</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        <span class="dv">2</span><span class="op">,</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span>p<span class="op">,</span> v<span class="op">)</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>            <span class="dt">var</span> cx <span class="op">=</span> img<span class="op">.</span><span class="fu">dimension</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">;</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>            <span class="dt">var</span> cy <span class="op">=</span> img<span class="op">.</span><span class="fu">dimension</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">;</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>            <span class="dt">var</span> ex <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">exp</span><span class="op">(-</span><span class="fl">0.020</span> <span class="op">*</span> <span class="op">(</span>p<span class="op">.</span><span class="fu">getDoublePosition</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">-</span> cx<span class="op">));</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>            <span class="dt">var</span> ey <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">exp</span><span class="op">(-</span><span class="fl">0.020</span> <span class="op">*</span> <span class="op">(</span>p<span class="op">.</span><span class="fu">getDoublePosition</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">-</span> cy<span class="op">));</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>            v<span class="op">.</span><span class="fu">setPosition</span><span class="op">(</span><span class="dv">10</span> <span class="op">+</span> <span class="dv">700</span> <span class="op">/</span> <span class="op">(</span><span class="dv">1</span> <span class="op">+</span> ex<span class="op">),</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>            v<span class="op">.</span><span class="fu">setPosition</span><span class="op">(</span><span class="dv">500</span> <span class="op">/</span> <span class="op">(</span> <span class="dv">1</span> <span class="op">+</span> ey<span class="op">),</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">},</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">()</span> <span class="op">-&gt;</span> <span class="op">{</span><span class="cf">return</span> DoubleType<span class="op">.</span><span class="fu">createVector</span><span class="op">(</span><span class="dv">2</span><span class="op">);});</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="co">// spacing of 10</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> spacing <span class="op">=</span> <span class="kw">new</span> <span class="dt">double</span><span class="op">[]{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">};</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> offset <span class="op">=</span> <span class="kw">new</span> <span class="dt">double</span><span class="op">[]{</span>img<span class="op">.</span><span class="fu">dimension</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">,</span> img<span class="op">.</span><span class="fu">dimension</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">};</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> pfield <span class="op">=</span> <span class="kw">new</span> <span class="fu">PositionFieldTransform</span><span class="op">(</span>pFieldVectorField<span class="op">);</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="co">// transform the image</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="fu">transformImage</span><span class="op">(</span>img<span class="op">,</span> pfield<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>
<figure class="figure">
<p><img src="2024-02-14-displacementFields_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Position fields can have different input and output dimensions. The length of the vector (first) dimension of the position field indicates its output dimension. The domain of the field indicates the input dimension. So generally, an N+1 dimensional image has N-dimensional inputs since one dimension is the vector dimension. Let’s consider an example.</p>
<div id="9aa0d01b" class="cell" data-execution_count="17">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> randPfieldData <span class="op">=</span> ArrayImgs<span class="op">.</span><span class="fu">doubles</span><span class="op">(</span><span class="dv">2</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">30</span><span class="op">,</span> <span class="dv">40</span><span class="op">,</span> <span class="dv">50</span><span class="op">);</span> <span class="co">// make a 5d array</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> pfieldRand <span class="op">=</span> <span class="kw">new</span> <span class="fu">PositionFieldTransform</span><span class="op">(</span>randPfieldData<span class="op">);</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">"input dimensions:  "</span> <span class="op">+</span> pfieldRand<span class="op">.</span><span class="fu">numSourceDimensions</span><span class="op">());</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">"output dimensions: "</span> <span class="op">+</span> pfieldRand<span class="op">.</span><span class="fu">numTargetDimensions</span><span class="op">());</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>input dimensions:  4
output dimensions: 2</code></pre>
</div>
</div>
<p>Make a 1D Function and plot it:</p>
<div id="ecdb004f" class="cell" data-execution_count="18">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">// a 1d signal</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> sin1d <span class="op">=</span> <span class="kw">new</span> FunctionRandomAccessible<span class="op">&lt;&gt;(</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span><span class="op">,</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span>p<span class="op">,</span> v<span class="op">)</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>            <span class="dt">double</span> t <span class="op">=</span> p<span class="op">.</span><span class="fu">getDoublePosition</span><span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>t <span class="op">&gt;</span> <span class="dv">250</span><span class="op">)</span> v<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="dv">64</span><span class="op">);</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> v<span class="op">.</span><span class="fu">setReal</span><span class="op">(</span><span class="dv">150</span> <span class="op">+</span> <span class="op">((</span>t<span class="op">/</span><span class="dv">5</span><span class="op">)</span> <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sin</span><span class="op">(</span>t<span class="op">/</span><span class="dv">10</span><span class="op">)));</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">},</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>        UnsignedByteType<span class="op">::</span><span class="kw">new</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="1186e756" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">// plot the 1d function</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> xpts <span class="op">=</span> <span class="kw">new</span> <span class="dt">double</span><span class="op">[</span><span class="dv">256</span><span class="op">];</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> ypts <span class="op">=</span> <span class="kw">new</span> <span class="dt">double</span><span class="op">[</span><span class="dv">256</span><span class="op">];</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> access <span class="op">=</span> sin1d<span class="op">.</span><span class="fu">randomAccess</span><span class="op">();</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>IntStream<span class="op">.</span><span class="fu">range</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">256</span><span class="op">).</span><span class="fu">forEach</span><span class="op">(</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>        i <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>            xpts<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>            access<span class="op">.</span><span class="fu">fwd</span><span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>            ypts<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> access<span class="op">.</span><span class="fu">get</span><span class="op">().</span><span class="fu">getRealDouble</span><span class="op">();</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> chart <span class="op">=</span> <span class="kw">new</span> <span class="fu">XYChartBuilder</span><span class="op">().</span><span class="fu">width</span><span class="op">(</span><span class="dv">800</span><span class="op">).</span><span class="fu">height</span><span class="op">(</span><span class="dv">600</span><span class="op">).</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>chart<span class="op">.</span><span class="fu">getStyler</span><span class="op">().</span><span class="fu">setChartTitleVisible</span><span class="op">(</span><span class="kw">false</span><span class="op">);</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>chart<span class="op">.</span><span class="fu">getStyler</span><span class="op">().</span><span class="fu">setLegendVisible</span><span class="op">(</span><span class="kw">false</span><span class="op">);</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>chart<span class="op">.</span><span class="fu">getStyler</span><span class="op">().</span><span class="fu">setChartTitleBoxBackgroundColor</span><span class="op">(</span>java<span class="op">.</span><span class="fu">awt</span><span class="op">.</span><span class="fu">Color</span><span class="op">.</span><span class="fu">white</span><span class="op">);</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>chart<span class="op">.</span><span class="fu">getStyler</span><span class="op">().</span><span class="fu">setChartBackgroundColor</span><span class="op">(</span>java<span class="op">.</span><span class="fu">awt</span><span class="op">.</span><span class="fu">Color</span><span class="op">.</span><span class="fu">white</span><span class="op">);</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> series <span class="op">=</span> chart<span class="op">.</span><span class="fu">addSeries</span><span class="op">(</span><span class="st">"function"</span><span class="op">,</span> xpts<span class="op">,</span> ypts<span class="op">);</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>series<span class="op">.</span><span class="fu">setMarker</span><span class="op">(</span>SeriesMarkers<span class="op">.</span><span class="fu">NONE</span><span class="op">);</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>BitmapEncoder<span class="op">.</span><span class="fu">getBufferedImage</span><span class="op">(</span>chart<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="19">
<div>
<figure class="figure">
<p><img src="2024-02-14-displacementFields_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="243225e1" class="cell" data-execution_count="20">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* </span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Create the position field (1D -&gt; 2D)</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * The details of this vector field are not so important,</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co"> * but notice:</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co"> *    1) it is some non-linear function.</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co"> *    2) its input p is a 2D; notice "p.getDoublePosition(i)"</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="co"> *    3) its output v is 1D (scalar)</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span> </span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> pFieldTransition <span class="op">=</span> <span class="kw">new</span> <span class="fu">PositionFieldTransform</span><span class="op">(</span> </span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> FunctionRealRandomAccessible<span class="op">&lt;&gt;(</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>            <span class="dv">2</span><span class="op">,</span> </span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">(</span>p<span class="op">,</span> v<span class="op">)</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>                <span class="dt">double</span> x <span class="op">=</span> p<span class="op">.</span><span class="fu">getDoublePosition</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">-</span> <span class="dv">300</span><span class="op">;</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>                <span class="dt">double</span> y <span class="op">=</span> p<span class="op">.</span><span class="fu">getDoublePosition</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">-</span> <span class="dv">300</span><span class="op">;</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>                <span class="dt">double</span> r <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sqrt</span><span class="op">(</span>x<span class="op">*</span>x <span class="op">+</span> y<span class="op">*</span>y<span class="op">);</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>                <span class="dt">double</span> tht <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">atan2</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>                v<span class="op">.</span><span class="fu">setPosition</span><span class="op">(</span><span class="fl">1.2</span> <span class="op">*</span> r <span class="op">+</span>  <span class="dv">32</span> <span class="op">*</span> tht<span class="op">,</span> <span class="dv">0</span><span class="op">);</span> </span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">},</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">()</span> <span class="op">-&gt;</span> <span class="op">{</span><span class="cf">return</span> DoubleType<span class="op">.</span><span class="fu">createVector</span><span class="op">(</span><span class="dv">1</span><span class="op">);})</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a><span class="co">// transform the 1D signal, make a 2D image of size 512 x 512</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a><span class="fu">transformImageInterval</span><span class="op">(</span>sin1d<span class="op">,</span> pFieldTransition<span class="op">,</span> <span class="kw">new</span> <span class="fu">FinalInterval</span><span class="op">(</span><span class="dv">512</span><span class="op">,</span> <span class="dv">512</span><span class="op">));</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="20">
<div>
<figure class="figure">
<p><img src="2024-02-14-displacementFields_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/imglib\.github\.io\/imglib2-blog");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>