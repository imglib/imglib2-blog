<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>ImgLib2 news and tutorials - Position and displacement field transforms</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../imglib2-logo-header.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">ImgLib2 news and tutorials</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">ImgLib2</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/imglib"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://fosstodon.org/@imglib2"> <i class="bi bi-mastodon" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Position and displacement field transforms</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button" data-quarto-source-url="https://github.com/imglib/imglib2-blog/blob/main/posts/2022-09-15-displacementFields.ipynb">View Source</a></li></ul></div></div>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="position-and-displacement-field-transforms" class="level1">
<h1>Position and displacement field transforms</h1>
<blockquote class="blockquote">
<p>Using and applying non-linear transformations with imglib2</p>
</blockquote>
<ul>
<li>toc: false</li>
<li>branch: main</li>
<li>badges: true</li>
<li>comments: true</li>
<li>author: John Bogovic</li>
<li>categories: [imglib2, transformation, transform, deformation, displacement ]</li>
</ul>
<p>This post shows how to create and apply non-linear transformations with imglib2, specifically using <code>DisplacementFieldTransform</code>s and <code>PositionFieldTransform</code>s.</p>
<p>The last example of this post will show how to use a <code>PositionFieldTransform</code> to transform this one-dimensional signal into a two-dimensional space, forming the image below.</p>
<table class="table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">A 1D function</th>
<th style="text-align: center;">The 2D image created after transformation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><img src="../images/function1d.png" title="A 1D Function" class="img-fluid" alt="A 1D function"></td>
<td style="text-align: center;"><img src="../images/shellFromPfield.png" title="The 2D image" class="img-fluid" alt="The 2D image"></td>
</tr>
</tbody>
</table>
<p>First, let’s set dependencies and import the classes we’ll use:</p>
<div id="37967562" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>loadFromPOM</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>repository<span class="op">&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>id<span class="op">&gt;</span>scijava<span class="op">.</span><span class="fu">public</span><span class="op">&lt;/</span>id<span class="op">&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>url<span class="op">&gt;</span>https<span class="op">:</span><span class="co">//maven.scijava.org/content/groups/public&lt;/url&gt;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>repository<span class="op">&gt;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>dependency<span class="op">&gt;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>groupId<span class="op">&gt;</span>net<span class="op">.</span><span class="fu">imglib2</span><span class="op">&lt;/</span>groupId<span class="op">&gt;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>artifactId<span class="op">&gt;</span>imglib2<span class="op">&lt;/</span>artifactId<span class="op">&gt;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>version<span class="op">&gt;</span><span class="fl">6.0.0</span><span class="op">&lt;/</span>version<span class="op">&gt;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>dependency<span class="op">&gt;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>dependency<span class="op">&gt;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>groupId<span class="op">&gt;</span>net<span class="op">.</span><span class="fu">imglib2</span><span class="op">&lt;/</span>groupId<span class="op">&gt;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>artifactId<span class="op">&gt;</span>imglib2<span class="op">-</span>realtransform<span class="op">&lt;/</span>artifactId<span class="op">&gt;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>version<span class="op">&gt;</span><span class="fl">4.0.0</span><span class="op">&lt;/</span>version<span class="op">&gt;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>dependency<span class="op">&gt;</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>dependency<span class="op">&gt;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>groupId<span class="op">&gt;</span>net<span class="op">.</span><span class="fu">imglib2</span><span class="op">&lt;/</span>groupId<span class="op">&gt;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>artifactId<span class="op">&gt;</span>imglib2<span class="op">-</span>ij<span class="op">&lt;/</span>artifactId<span class="op">&gt;</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>version<span class="op">&gt;</span><span class="fl">2.0.0</span><span class="op">-</span>beta<span class="op">-</span><span class="dv">46</span><span class="op">&lt;/</span>version<span class="op">&gt;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>dependency<span class="op">&gt;</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>dependency<span class="op">&gt;</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>groupId<span class="op">&gt;</span>org<span class="op">.</span><span class="fu">knowm</span><span class="op">.</span><span class="fu">xchart</span><span class="op">&lt;/</span>groupId<span class="op">&gt;</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>artifactId<span class="op">&gt;</span>xchart<span class="op">&lt;/</span>artifactId<span class="op">&gt;</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>version<span class="op">&gt;</span><span class="fl">3.5.4</span><span class="op">&lt;/</span>version<span class="op">&gt;</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>dependency<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="d3ca9c57" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">function</span><span class="op">.*;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">stream</span><span class="op">.*;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">io</span><span class="op">.</span><span class="im">github</span><span class="op">.</span><span class="im">spencerpark</span><span class="op">.</span><span class="im">jupyter</span><span class="op">.</span><span class="im">kernel</span><span class="op">.</span><span class="im">display</span><span class="op">.</span><span class="im">common</span><span class="op">.*;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">io</span><span class="op">.</span><span class="im">github</span><span class="op">.</span><span class="im">spencerpark</span><span class="op">.</span><span class="im">jupyter</span><span class="op">.</span><span class="im">kernel</span><span class="op">.</span><span class="im">display</span><span class="op">.</span><span class="im">mime</span><span class="op">.*;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.*;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.</span><span class="im">view</span><span class="op">.*;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.</span><span class="im">realtransform</span><span class="op">.*;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.</span><span class="im">position</span><span class="op">.*;</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.</span><span class="im">type</span><span class="op">.</span><span class="im">numeric</span><span class="op">.</span><span class="im">real</span><span class="op">.*;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.</span><span class="im">type</span><span class="op">.</span><span class="im">numeric</span><span class="op">.</span><span class="im">integer</span><span class="op">.*;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.</span><span class="im">img</span><span class="op">.</span><span class="im">array</span><span class="op">.</span><span class="im">ArrayImgs</span><span class="op">;</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.</span><span class="im">util</span><span class="op">.*;</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.</span><span class="im">interpolation</span><span class="op">.</span><span class="im">randomaccess</span><span class="op">.*;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.</span><span class="im">img</span><span class="op">.</span><span class="im">display</span><span class="op">.</span><span class="im">imagej</span><span class="op">.*;</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">knowm</span><span class="op">.</span><span class="im">xchart</span><span class="op">.*;</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">knowm</span><span class="op">.</span><span class="im">xchart</span><span class="op">.</span><span class="im">style</span><span class="op">.</span><span class="im">Styler</span><span class="op">.</span><span class="im">LegendPosition</span><span class="op">;</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">knowm</span><span class="op">.</span><span class="im">xchart</span><span class="op">.</span><span class="im">style</span><span class="op">.</span><span class="im">markers</span><span class="op">.</span><span class="im">SeriesMarkers</span><span class="op">;</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="fu">getKernelInstance</span><span class="op">().</span><span class="fu">getRenderer</span><span class="op">().</span><span class="fu">createRegistration</span><span class="op">(</span>RandomAccessibleInterval<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">preferring</span><span class="op">(</span>MIMEType<span class="op">.</span><span class="fu">IMAGE_PNG</span><span class="op">)</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">supporting</span><span class="op">(</span>MIMEType<span class="op">.</span><span class="fu">IMAGE_JPEG</span><span class="op">,</span> MIMEType<span class="op">.</span><span class="fu">IMAGE_GIF</span><span class="op">)</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">register</span><span class="op">((</span>rai<span class="op">,</span> context<span class="op">)</span> <span class="op">-&gt;</span> <span class="bu">Image</span><span class="op">.</span><span class="fu">renderImage</span><span class="op">(</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>                ImageJFunctions<span class="op">.</span><span class="fu">wrap</span><span class="op">(</span>rai<span class="op">,</span> rai<span class="op">.</span><span class="fu">toString</span><span class="op">()).</span><span class="fu">getBufferedImage</span><span class="op">(),</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>                context<span class="op">));</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> printWriter <span class="op">=</span> <span class="kw">new</span> <span class="bu">PrintWriter</span><span class="op">(</span><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">,</span><span class="kw">true</span><span class="op">);</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> rarrow <span class="op">=</span> <span class="ch">'\u2192'</span><span class="op">;</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">printTformPts</span><span class="op">(</span> RealPoint x<span class="op">,</span> RealPoint y <span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    printWriter<span class="op">.</span><span class="fu">println</span><span class="op">(</span> <span class="bu">String</span><span class="op">.</span><span class="fu">format</span><span class="op">(</span><span class="st">"</span><span class="sc">%s</span><span class="st"> </span><span class="sc">%s</span><span class="st"> </span><span class="sc">%s</span><span class="st">"</span><span class="op">,</span> x<span class="op">,</span> rarrow<span class="op">,</span> y<span class="op">));</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="displacement-fields" class="level1">
<h1>Displacement fields</h1>
<p>A displacement field is the most common way to represent and store non-linear transformations. Imagine an image where a vector is stored at every position <span class="math inline">\(\mathbf{x}\)</span>. That vector describes how much and in what direction the position <span class="math inline">\(\mathbf{x}\)</span> should be translated, or displaced.</p>
<p><span class="math display">\[
\begin{align}
\mathbf{x} &amp;: \text{a position } \\
\mathbf{v}( \mathbf{x} ) &amp;: \text{the vector at position } \mathbf{x}\\
\mathbf{x} + \mathbf{v}( \mathbf{x} ) &amp;: \text{the output of the transformation}
\end{align}
\]</span></p>
<p>For example, let’s consider an example vector field with the vector <span class="math inline">\([50, -25]\)</span> at every position. This will be equivalent to a simple global translation and is not <a href="https://javadoc.scijava.org/ImgLib2/net/imglib2/realtransform/Translation.html">the recommended way to represent a translation</a>, but will be instructive thanks to its simplicity.</p>
<p>A <a href="https://javadoc.scijava.org/ImgLib2/net/imglib2/position/FunctionRealRandomAccessible.html"><code>FunctionRealRandomAccessible</code></a> is one way to make a image containing a constant value (<a href="https://javadoc.scijava.org/ImgLib2/net/imglib2/util/ConstantUtils.html"><code>ConstantUtils</code></a> is another way). This image can be passed directly to imglib2’s <code>DisplacementFieldTransform</code>.</p>
<div id="32b50ba3" class="cell" data-execution_count="27">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> displacementVector <span class="op">=</span> <span class="kw">new</span> <span class="dt">double</span><span class="op">[]{</span> <span class="dv">50</span><span class="op">,</span> <span class="op">-</span><span class="dv">25</span> <span class="op">};</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> constantVector <span class="op">=</span> <span class="kw">new</span> FunctionRealRandomAccessible<span class="op">&lt;&gt;(</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>x<span class="op">,</span> v<span class="op">)</span> <span class="op">-&gt;</span> <span class="op">{</span> v<span class="op">.</span><span class="fu">setPosition</span><span class="op">(</span> displacementVector <span class="op">);</span> <span class="op">},</span>  <span class="co">// set the vector </span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">()</span> <span class="op">-&gt;</span> <span class="op">{</span> <span class="cf">return</span> DoubleType<span class="op">.</span><span class="fu">createVector</span><span class="op">(</span> <span class="dv">2</span> <span class="op">);</span> <span class="op">});</span>     <span class="co">// make a 2d vector</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> dfieldConstant <span class="op">=</span> <span class="kw">new</span> <span class="fu">DisplacementFieldTransform</span><span class="op">(</span> constantVector <span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Applying the transformation to any point translates that point by the same amount <span class="math inline">\([50, -25]\)</span> , as expected:</p>
<div id="d8d98dc6" class="cell" data-execution_count="29">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// two ways of initializing a point (0.0, 0.0)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span> <span class="op">);</span> <span class="co">// give the coordinates as arguments</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> y <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="dv">2</span> <span class="op">);</span>        <span class="co">// give the number of dimensions as an argument</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">// transform x, store the result in y</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>dfieldConstant<span class="op">.</span><span class="fu">apply</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">// [-50,25] is transformed to [0,0]</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span>y<span class="op">);</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="op">-</span><span class="dv">50</span><span class="op">,</span> <span class="dv">25</span> <span class="op">);</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>dfieldConstant<span class="op">.</span><span class="fu">apply</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">// [-50,25] is transformed to [0,0]</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span>y<span class="op">);</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">PI</span><span class="op">,</span> <span class="dv">100000</span> <span class="op">);</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>dfieldConstant<span class="op">.</span><span class="fu">apply</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co">// [pi, 100k] is transformed to [50+pi, 100k - 25]</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span>y<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(0.0,0.0) → (50.0,-25.0)
(-50.0,25.0) → (0.0,0.0)
(3.141592653589793,100000.0) → (53.1415926535898,99975.0)</code></pre>
</div>
</div>
<p>Let’s make a slightly more interesting displacement field with four vectors - one at each corner. Our image will be:</p>
<pre><code>----------------
|[1, 1]  [2, 2]|
|[3, 3]  [4, 4]|
----------------</code></pre>
<p>i.e.&nbsp;the vector is <span class="math inline">\([3,3]\)</span> is at position (0,1)</p>
<p>Our data needs to be 3D, where the first dimension holds the two vector components, and the other two hold the spatial dimensions. We can use an <a href="https://javadoc.scijava.org/ImgLib2/net/imglib2/img/array/ArrayImgs.html"><code>ArrayImg</code></a> to store these data.</p>
<div id="2d9d5fd7" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> dfieldData <span class="op">=</span> ArrayImgs<span class="op">.</span><span class="fu">doubles</span><span class="op">(</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="dt">double</span><span class="op">[]{</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">4</span> <span class="op">},</span> <span class="co">// the data</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">2</span> <span class="op">);</span>  <span class="co">// the dimensions</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> dfieldCorners <span class="op">=</span> <span class="kw">new</span> <span class="fu">DisplacementFieldTransform</span><span class="op">(</span> dfieldData <span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-error">
<pre><code>CompilationException: </code></pre>
</div>
</div>
<p>For example, we expect the transform to take the point <span class="math inline">\([0,1]\)</span> to <span class="math inline">\([3,4] = [0,1] + [3,3]\)</span>, and that is indeed what we see:</p>
<div id="6ce981de" class="cell" data-execution_count="34">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// [0,0] is transformed to [1,1] = [0,0] + [1,1]</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span> <span class="op">);</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> y <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="dv">2</span> <span class="op">);</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>dfieldCorners<span class="op">.</span><span class="fu">apply</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">// [1,0] is transformed to [3,2] = [1,0] + [2,2]</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="fl">1.0</span><span class="op">,</span> <span class="fl">0.0</span> <span class="op">);</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>dfieldCorners<span class="op">.</span><span class="fu">apply</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co">// [0,1] is transformed to [3,4] = [0,1] + [3,3]</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">1.0</span> <span class="op">);</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>dfieldCorners<span class="op">.</span><span class="fu">apply</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="co">// [1,1] is transformed to [5,5] = [1,1] + [4,4]</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span> <span class="op">);</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>dfieldCorners<span class="op">.</span><span class="fu">apply</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(0.0,0.0) → (1.0,1.0)
(1.0,0.0) → (3.0,2.0)
(0.0,1.0) → (3.0,4.0)
(1.0,1.0) → (5.0,5.0)</code></pre>
</div>
</div>
<p>What happens if we try to apply the transformation “in between” the discrete values of the array, or out-of-bounds of the array?</p>
<div id="c49470ea" class="cell" data-execution_count="35">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="fl">0.5</span><span class="op">,</span> <span class="fl">0.5</span> <span class="op">);</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> y <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="dv">2</span> <span class="op">);</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>dfieldCorners<span class="op">.</span><span class="fu">apply</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">// [0.5, 0.5] is transformed to [3.0, 3.0]</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span>y<span class="op">);</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="op">-</span><span class="dv">100</span><span class="op">,</span> <span class="op">-</span><span class="dv">100</span> <span class="op">);</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> y <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="dv">2</span> <span class="op">);</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>dfieldCorners<span class="op">.</span><span class="fu">apply</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co">// [-100, -100] is transformed to [-99.0,-99.0]</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span>y<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(0.5,0.5) → (3.0,3.0)
(-100.0,-100.0) → (-99.0,-99.0)</code></pre>
</div>
</div>
<p>By default, linear interpolation determines the displacement within the array but off of grid values. The nearest value on the border of the array determines the displacement outside the bounds. If instead we want nearest-neighbor interpolation and all out-of-bounds displacements to be zero it can be acheived by:</p>
<div id="6e18a5df" class="cell" data-execution_count="24">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">// interpret our 3d image as a 2d image of vectors</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> vectorsFrom3D <span class="op">=</span> Views<span class="op">.</span><span class="fu">collapseReal</span><span class="op">(</span> Views<span class="op">.</span><span class="fu">moveAxis</span><span class="op">(</span> dfieldData<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> dfieldData<span class="op">.</span><span class="fu">numDimensions</span><span class="op">()</span> <span class="op">-</span> <span class="dv">1</span> <span class="op">));</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">// make the displacement field with custom interpolation and boundary extension</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> dfieldCornersCustom <span class="op">=</span> <span class="kw">new</span> <span class="fu">DisplacementFieldTransform</span><span class="op">(</span> </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    Views<span class="op">.</span><span class="fu">interpolate</span><span class="op">(</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        Views<span class="op">.</span><span class="fu">extendZero</span><span class="op">(</span> vectorsFrom3D <span class="op">),</span>          <span class="co">// zeros out-of-bounds</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="fu">NearestNeighborInterpolatorFactory</span><span class="op">()</span> <span class="op">));</span> <span class="co">// nearest-neighbor interpolation</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="fl">0.4</span><span class="op">,</span> <span class="fl">0.4</span> <span class="op">);</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> y <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="dv">2</span> <span class="op">);</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>dfieldCornersCustom<span class="op">.</span><span class="fu">apply</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span>y<span class="op">);</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="op">-</span><span class="dv">100</span><span class="op">,</span> <span class="op">-</span><span class="dv">100</span> <span class="op">);</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> y <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="dv">2</span> <span class="op">);</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>dfieldCornersCustom<span class="op">.</span><span class="fu">apply</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span>y<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(0.4,0.4) → (-44.6,-49.6)
(-100.0,-100.0) → (-100.0,-100.0)</code></pre>
</div>
</div>
<p>Another common requirement is to specify the spacing and offset of the displacement field’s discrete grid. For example, suppose we want the displacements above to be applied to the field of view <span class="math inline">\([-10, 10] \times [-20, 20]\)</span> rather than the array coordinates <span class="math inline">\([0, 1] \times [0, 1]\)</span>.</p>
<pre><code>(-10,-20)  ------------------------------------------------  (10,-20)
           |[1,1]                                    [2,2]|
           |                                              |                                          
           |                                              |
           |                                              |
           |            (interpolated values)             |
           |                                              |
           |                                              |
           |                                              |
           |[3,3]                                    [4,4]|
(-10, 20)  ------------------------------------------------ (10,20)               </code></pre>
<p>where the values outside the box are the coordinates of the corners.</p>
<p>This is possible by passing the desired spacing and offset directly to the <code>DisplacementFieldTransform</code>.</p>
<div id="adcdfde8" class="cell" data-execution_count="39">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * the spacing and offset below map the array origin [0,0] to [-10,-20]</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * and the element at array index [1,1] to [10,20]</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> spacing <span class="op">=</span> <span class="kw">new</span> <span class="dt">double</span><span class="op">[]{</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">40</span> <span class="op">};</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> offset <span class="op">=</span> <span class="kw">new</span> <span class="dt">double</span><span class="op">[]{</span> <span class="op">-</span><span class="dv">10</span><span class="op">,</span> <span class="op">-</span><span class="dv">20</span> <span class="op">};</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> dfieldCornersSpacingOffset <span class="op">=</span> <span class="kw">new</span> <span class="fu">DisplacementFieldTransform</span><span class="op">(</span> dfieldData<span class="op">,</span> spacing<span class="op">,</span> offset <span class="op">);</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">// [-10,-20] is displaced by the vector [1,1], so goes to [-9,-19]</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="op">-</span><span class="dv">10</span><span class="op">,</span> <span class="op">-</span><span class="dv">20</span> <span class="op">);</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> y <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="dv">2</span> <span class="op">);</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>dfieldCornersSpacingOffset<span class="op">.</span><span class="fu">apply</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co">// similarly, [10,20] is displaced by the vector [4,4], so goes to [14,24]</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">20</span> <span class="op">);</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> y <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="dv">2</span> <span class="op">);</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>dfieldCornersSpacingOffset<span class="op">.</span><span class="fu">apply</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(-10.0,-20.0) → (-9.0,-19.0)
(10.0,20.0) → (14.0,24.0)</code></pre>
</div>
</div>
</section>
<section id="transforming-images" class="level1">
<h1>Transforming images</h1>
<p>Displacement fields can also be applied to images. First, let’s open an image:</p>
<div id="076500c6" class="cell" data-execution_count="10">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">ij</span><span class="op">.*;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> imp <span class="op">=</span> IJ<span class="op">.</span><span class="fu">openImage</span><span class="op">(</span><span class="st">"https://mirror.imagej.net/ij/images/boats.gif"</span><span class="op">);</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>imp<span class="op">.</span><span class="fu">getBufferedImage</span><span class="op">();</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>
<figure class="figure">
<p><img src="2022-09-15-displacementFields_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Now let’s transform it using our constant valued displacement field. Remember this field has the vector <span class="math inline">\([50, -25]\)</span> everwhere.</p>
<p>First, we’ll define two functions for transforming images:</p>
<div id="20fd473f" class="cell" data-execution_count="11">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> RandomAccessibleInterval <span class="fu">transformImageItvl</span><span class="op">(</span> RandomAccessible img<span class="op">,</span> RealTransform transform<span class="op">,</span> Interval itvl <span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// interpolate the input image</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> interpImg <span class="op">=</span> Views<span class="op">.</span><span class="fu">interpolate</span><span class="op">(</span> img<span class="op">,</span> <span class="kw">new</span> <span class="fu">NLinearInterpolatorFactory</span><span class="op">());</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// transform the image</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> transformedImg <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealTransformRandomAccessible</span><span class="op">(</span>interpImg<span class="op">,</span> transform <span class="op">);</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// rasterize and set bounding box</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Views<span class="op">.</span><span class="fu">interval</span><span class="op">(</span> Views<span class="op">.</span><span class="fu">raster</span><span class="op">(</span>transformedImg<span class="op">),</span> itvl <span class="op">)</span> <span class="op">;</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> RandomAccessibleInterval <span class="fu">transformImage</span><span class="op">(</span> RandomAccessibleInterval img<span class="op">,</span> RealTransform transform <span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// default out-of-bounds extension and output interval</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">transformImageItvl</span><span class="op">(</span> Views<span class="op">.</span><span class="fu">extendZero</span><span class="op">(</span> img <span class="op">),</span> transform<span class="op">,</span> img <span class="op">);</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="0f3a7830" class="cell" data-execution_count="12">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> imgTransformed <span class="op">=</span> <span class="fu">transformImage</span><span class="op">(</span> ImageJFunctions<span class="op">.</span><span class="fu">wrap</span><span class="op">(</span> imp <span class="op">),</span> dfieldConstant <span class="op">);</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>imgTransformed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>
<figure class="figure">
<p><img src="2022-09-15-displacementFields_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Notice that the image is shifted down (+y direction) and to the left (-x direction), has the opposite sign of the displacement vector. This is because the “inverse” transformation (from output coordinates to input coordinates) is needed to transform images. <a href="https://github.com/bogovicj/transforms_tutorial/blob/master/resources/2019_DAIS.pdf">Learn why here</a>.</p>
<p>Now let’s use what we learned above to make a displacement field whose corners are the corners of the image.</p>
<div id="f19410cc" class="cell" data-execution_count="13">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">net</span><span class="op">.</span><span class="im">imglib2</span><span class="op">.</span><span class="im">img</span><span class="op">.</span><span class="im">array</span><span class="op">.</span><span class="im">ArrayImgs</span><span class="op">;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co">// some vector field</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> dfieldData <span class="op">=</span> ArrayImgs<span class="op">.</span><span class="fu">doubles</span><span class="op">(</span> </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="dt">double</span><span class="op">[]{</span> <span class="op">-</span><span class="dv">45</span><span class="op">,</span> <span class="op">-</span><span class="dv">50</span><span class="op">,</span> <span class="dv">35</span><span class="op">,</span> <span class="op">-</span><span class="dv">35</span><span class="op">,</span> <span class="op">-</span><span class="dv">25</span><span class="op">,</span> <span class="dv">25</span><span class="op">,</span> <span class="dv">70</span><span class="op">,</span> <span class="dv">75</span> <span class="op">},</span>  <span class="co">// the vector data</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">2</span> <span class="op">);</span> <span class="co">// the dimensions</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">// use the image width and height as the vector fields spacing</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> dfield <span class="op">=</span> <span class="kw">new</span> <span class="fu">DisplacementFieldTransform</span><span class="op">(</span> dfieldData<span class="op">,</span> imp<span class="op">.</span><span class="fu">getWidth</span><span class="op">(),</span> imp<span class="op">.</span><span class="fu">getHeight</span><span class="op">()</span> <span class="op">);</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co">// transform the image</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> imgTransformed <span class="op">=</span> <span class="fu">transformImage</span><span class="op">(</span> ImageJFunctions<span class="op">.</span><span class="fu">wrap</span><span class="op">(</span> imp <span class="op">),</span> dfield <span class="op">);</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>imgTransformed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>
<figure class="figure">
<p><img src="2022-09-15-displacementFields_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Finally, let’s make a field of random displacements at one-tenth the resolution of the image and apply it.</p>
<div id="d925a15d" class="cell" data-scrolled="true" data-execution_count="14">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">// create image of random vectors</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> randDfieldData <span class="op">=</span> ArrayImgs<span class="op">.</span><span class="fu">doubles</span><span class="op">(</span> <span class="dv">2</span><span class="op">,</span> <span class="op">(</span><span class="dt">long</span><span class="op">)(</span>imp<span class="op">.</span><span class="fu">getWidth</span><span class="op">()</span> <span class="op">/</span> <span class="dv">20</span><span class="op">),</span> <span class="op">(</span><span class="dt">long</span><span class="op">)(</span>imp<span class="op">.</span><span class="fu">getHeight</span><span class="op">()</span> <span class="op">/</span> <span class="dv">20</span><span class="op">)</span> <span class="op">);</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>randDfieldData<span class="op">.</span><span class="fu">forEach</span><span class="op">(</span> x <span class="op">-&gt;</span> <span class="op">{</span> x<span class="op">.</span><span class="fu">set</span><span class="op">(</span> <span class="dv">15</span> <span class="op">*</span> <span class="op">(</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">random</span><span class="op">()</span> <span class="op">-</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">);</span> <span class="op">});</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">// spacing of 20</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> dfield <span class="op">=</span> <span class="kw">new</span> <span class="fu">DisplacementFieldTransform</span><span class="op">(</span> randDfieldData<span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">20</span> <span class="op">);</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co">// transform the image</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> imgTransformed <span class="op">=</span> <span class="fu">transformImage</span><span class="op">(</span> ImageJFunctions<span class="op">.</span><span class="fu">wrap</span><span class="op">(</span> imp <span class="op">),</span> dfield <span class="op">);</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>imgTransformed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>
<figure class="figure">
<p><img src="2022-09-15-displacementFields_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="position-fields" class="level1">
<h1>Position fields</h1>
<p>A position, or coordinate field is similar to a displacement field in that it is also represented by a field of vectors, but those vectors represent positions directly, rather than displacements of the current position.</p>
<p><span class="math display">\[
\begin{align}
\mathbf{x} &amp;: \text{a position } \\
\mathbf{v}( \mathbf{x} ) &amp;: \text{the vector at position } \mathbf{x}\\
\mathbf{v}( \mathbf{x} ) &amp;: \text{the output of the transformation}
\end{align}
\]</span></p>
<p>If we use a constant vector field to make a <code>PositionFieldTransform</code> the output will always be the same:</p>
<div id="d9648004" class="cell" data-execution_count="40">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> coordinateVector <span class="op">=</span> <span class="kw">new</span> <span class="dt">double</span><span class="op">[]{</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span> <span class="op">};</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> constantVector <span class="op">=</span> <span class="kw">new</span> FunctionRealRandomAccessible<span class="op">&lt;&gt;(</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>x<span class="op">,</span> v<span class="op">)</span> <span class="op">-&gt;</span> <span class="op">{</span> v<span class="op">.</span><span class="fu">setPosition</span><span class="op">(</span> displacementVector <span class="op">);</span> <span class="op">},</span>  <span class="co">// set the vector </span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">()</span> <span class="op">-&gt;</span> <span class="op">{</span> <span class="cf">return</span> DoubleType<span class="op">.</span><span class="fu">createVector</span><span class="op">(</span> <span class="dv">2</span> <span class="op">);</span> <span class="op">});</span>     <span class="co">// make a 2d vector</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> pfieldConstant <span class="op">=</span> <span class="kw">new</span> <span class="fu">PositionFieldTransform</span><span class="op">(</span> constantVector <span class="op">);</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span> <span class="op">);</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> y <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="dv">2</span> <span class="op">);</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>pfieldConstant<span class="op">.</span><span class="fu">apply</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span>y<span class="op">);</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="dv">9999</span><span class="op">,</span> <span class="dv">9999</span> <span class="op">);</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> y <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="dv">2</span> <span class="op">);</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>pfieldConstant<span class="op">.</span><span class="fu">apply</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span>y<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(0.0,0.0) → (50.0,-25.0)
(9999.0,9999.0) → (50.0,-25.0)</code></pre>
</div>
</div>
<p>The <code>Localizables</code> class has some convenience methods for producing images of coordinates. Creating a position field with this image gives the identity. <code>FunctionRandomAccessible</code>s can also be used to generate coordinate images.</p>
<div id="54bbb463" class="cell" data-execution_count="41">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> coordinates <span class="op">=</span> Localizables<span class="op">.</span><span class="fu">realRandomAccessible</span><span class="op">(</span> <span class="dv">2</span> <span class="op">);</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> xCoordinates <span class="op">=</span> Views<span class="op">.</span><span class="fu">interval</span><span class="op">(</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> FunctionRandomAccessible<span class="op">&lt;&gt;(</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span>x<span class="op">,</span> v<span class="op">)</span> <span class="op">-&gt;</span> <span class="op">{</span> v<span class="op">.</span><span class="fu">set</span><span class="op">(</span> x<span class="op">.</span><span class="fu">getIntPosition</span><span class="op">(</span> <span class="dv">0</span> <span class="op">));</span> <span class="op">},</span> </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">()</span> <span class="op">-&gt;</span> <span class="op">{</span> <span class="cf">return</span> <span class="kw">new</span> <span class="fu">UnsignedByteType</span><span class="op">();</span> <span class="op">}),</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="fu">FinalInterval</span><span class="op">(</span> <span class="dv">255</span><span class="op">,</span> <span class="dv">255</span> <span class="op">));</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span><span class="op">(</span> <span class="st">"x coordinates"</span><span class="op">);</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span><span class="op">(</span> xCoordinates <span class="op">);</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span><span class="op">(</span> <span class="st">" "</span><span class="op">);</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> yCoordinates <span class="op">=</span> Views<span class="op">.</span><span class="fu">interval</span><span class="op">(</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> FunctionRandomAccessible<span class="op">&lt;&gt;(</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span>x<span class="op">,</span> v<span class="op">)</span> <span class="op">-&gt;</span> <span class="op">{</span> v<span class="op">.</span><span class="fu">set</span><span class="op">(</span> x<span class="op">.</span><span class="fu">getIntPosition</span><span class="op">(</span> <span class="dv">1</span> <span class="op">));</span> <span class="op">},</span> </span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">()</span> <span class="op">-&gt;</span> <span class="op">{</span> <span class="cf">return</span> <span class="kw">new</span> <span class="fu">UnsignedByteType</span><span class="op">();</span> <span class="op">}),</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="fu">FinalInterval</span><span class="op">(</span> <span class="dv">255</span><span class="op">,</span> <span class="dv">255</span> <span class="op">));</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span><span class="op">(</span> <span class="st">"y coordinates"</span><span class="op">);</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span><span class="op">(</span> yCoordinates <span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>x coordinates</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2022-09-15-displacementFields_files/figure-html/cell-17-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<pre><code> </code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>y coordinates</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2022-09-15-displacementFields_files/figure-html/cell-17-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>86c05009-2661-4d94-bbc3-0254741ddd31</code></pre>
</div>
</div>
<div id="e2fe4c43" class="cell" data-execution_count="42">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">// the identity transformation</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> identityPfield <span class="op">=</span> <span class="kw">new</span> <span class="fu">PositionFieldTransform</span><span class="op">(</span> Localizables<span class="op">.</span><span class="fu">realRandomAccessible</span><span class="op">(</span> <span class="dv">2</span> <span class="op">));</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span> <span class="op">);</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> y <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="dv">2</span> <span class="op">);</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>identityPfield<span class="op">.</span><span class="fu">apply</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span>y<span class="op">);</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> x <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="dv">9999</span><span class="op">,</span> <span class="dv">9999</span> <span class="op">);</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> y <span class="op">=</span> <span class="kw">new</span> <span class="fu">RealPoint</span><span class="op">(</span> <span class="dv">2</span> <span class="op">);</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>identityPfield<span class="op">.</span><span class="fu">apply</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="fu">printTformPts</span><span class="op">(</span>x<span class="op">,</span>y<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(0.0,0.0) → (0.0,0.0)
(9999.0,9999.0) → (9999.0,9999.0)</code></pre>
</div>
</div>
<p>For the above examples, notice that the <code>identityPfield</code> does indeed behaves as the identity transformation.</p>
<p>Let’s make another position field that stretches and compresses the image in a non-linear way.</p>
<div id="82a948dc" class="cell" data-execution_count="43">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> pFieldVectorField <span class="op">=</span> <span class="kw">new</span> FunctionRealRandomAccessible<span class="op">&lt;&gt;(</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>p<span class="op">,</span> v<span class="op">)</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> cx <span class="op">=</span> imp<span class="op">.</span><span class="fu">getWidth</span><span class="op">()</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">;</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> cy <span class="op">=</span> imp<span class="op">.</span><span class="fu">getHeight</span><span class="op">()</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">;</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> ex <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">exp</span><span class="op">(</span> <span class="op">-</span><span class="fl">0.020</span> <span class="op">*</span> <span class="op">(</span>p<span class="op">.</span><span class="fu">getDoublePosition</span><span class="op">(</span> <span class="dv">0</span> <span class="op">)</span> <span class="op">-</span> cx <span class="op">));</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> ey <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">exp</span><span class="op">(</span> <span class="op">-</span><span class="fl">0.020</span> <span class="op">*</span> <span class="op">(</span>p<span class="op">.</span><span class="fu">getDoublePosition</span><span class="op">(</span> <span class="dv">1</span> <span class="op">)</span> <span class="op">-</span> cy <span class="op">));</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>        v<span class="op">.</span><span class="fu">setPosition</span><span class="op">(</span> <span class="dv">10</span> <span class="op">+</span> <span class="dv">700</span> <span class="op">/</span> <span class="op">(</span> <span class="dv">1</span> <span class="op">+</span> ex <span class="op">),</span> <span class="dv">0</span> <span class="op">);</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>        v<span class="op">.</span><span class="fu">setPosition</span><span class="op">(</span> <span class="dv">500</span> <span class="op">/</span> <span class="op">(</span> <span class="dv">1</span> <span class="op">+</span> ey <span class="op">),</span> <span class="dv">1</span> <span class="op">);</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">},</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">()</span> <span class="op">-&gt;</span> <span class="op">{</span> <span class="cf">return</span> DoubleType<span class="op">.</span><span class="fu">createVector</span><span class="op">(</span> <span class="dv">2</span> <span class="op">);</span> <span class="op">});</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co">// spacing of 10</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> spacing <span class="op">=</span> <span class="kw">new</span> <span class="dt">double</span><span class="op">[]{</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span> <span class="op">};</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> offset <span class="op">=</span> <span class="kw">new</span> <span class="dt">double</span><span class="op">[]{</span> imp<span class="op">.</span><span class="fu">getWidth</span><span class="op">()</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">,</span>  imp<span class="op">.</span><span class="fu">getHeight</span><span class="op">()</span> <span class="op">/</span> <span class="fl">2.0</span> <span class="op">};</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> pfield <span class="op">=</span> <span class="kw">new</span> <span class="fu">PositionFieldTransform</span><span class="op">(</span> pFieldVectorField <span class="op">);</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="co">// transform the image</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> imgTransformed <span class="op">=</span> <span class="fu">transformImage</span><span class="op">(</span> ImageJFunctions<span class="op">.</span><span class="fu">wrap</span><span class="op">(</span> imp <span class="op">),</span> pfield <span class="op">);</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>imgTransformed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="43">
<div>
<figure class="figure">
<p><img src="2022-09-15-displacementFields_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Position fields can have different input and output dimensions. The length of the vector (first) dimension of the position field indicates its output dimension. The domain of the field indicates the input dimension. So generally, an N+1 dimensional image has N-dimensional inputs since one dimension is the vector dimension. Let’s consider an example.</p>
<div id="f5854679" class="cell" data-execution_count="19">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> randPfieldData <span class="op">=</span> ArrayImgs<span class="op">.</span><span class="fu">doubles</span><span class="op">(</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">30</span><span class="op">,</span> <span class="dv">40</span><span class="op">,</span> <span class="dv">50</span> <span class="op">);</span> <span class="co">// make a 5d array</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> pfieldRand <span class="op">=</span> <span class="kw">new</span> <span class="fu">PositionFieldTransform</span><span class="op">(</span> randPfieldData <span class="op">);</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span> <span class="st">"input dimensions:  "</span> <span class="op">+</span> pfieldRand<span class="op">.</span><span class="fu">numSourceDimensions</span><span class="op">()</span> <span class="op">);</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span> <span class="st">"output dimensions: "</span> <span class="op">+</span> pfieldRand<span class="op">.</span><span class="fu">numTargetDimensions</span><span class="op">()</span> <span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>input dimensions:  4
output dimensions: 2</code></pre>
</div>
</div>
<p>Let’s make another example, transforming a 1D signal into a 2D space. First, we’ll make and graph a 1D signal with a <code>FunctionRandomAccessible</code>.</p>
<div id="81c54610" class="cell" data-execution_count="22">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">// a 1d signal</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> sin1d <span class="op">=</span> <span class="kw">new</span> FunctionRandomAccessible<span class="op">&lt;&gt;(</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>p<span class="op">,</span> v<span class="op">)</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">double</span> t <span class="op">=</span> p<span class="op">.</span><span class="fu">getDoublePosition</span><span class="op">(</span> <span class="dv">0</span> <span class="op">);</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span> t <span class="op">&gt;</span> <span class="dv">250</span> <span class="op">)</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>            v<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="dv">64</span><span class="op">);</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>            v<span class="op">.</span><span class="fu">setReal</span><span class="op">(</span> <span class="dv">150</span> <span class="op">+</span> <span class="op">(</span> <span class="op">(</span>t<span class="op">/</span><span class="dv">5</span><span class="op">)</span> <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sin</span><span class="op">(</span> t <span class="op">/</span> <span class="dv">10</span> <span class="op">))</span> <span class="op">);</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">},</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    UnsignedByteType<span class="op">::</span><span class="kw">new</span> <span class="op">);</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="co">// plot the 1d function</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> xpts <span class="op">=</span> <span class="kw">new</span> <span class="dt">double</span><span class="op">[</span><span class="dv">256</span><span class="op">];</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> ypts <span class="op">=</span> <span class="kw">new</span> <span class="dt">double</span><span class="op">[</span><span class="dv">256</span><span class="op">];</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> access <span class="op">=</span> sin1d<span class="op">.</span><span class="fu">randomAccess</span><span class="op">();</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>IntStream<span class="op">.</span><span class="fu">range</span><span class="op">(</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">256</span> <span class="op">).</span><span class="fu">forEach</span><span class="op">(</span> i <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    xpts<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    access<span class="op">.</span><span class="fu">fwd</span><span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    ypts<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> access<span class="op">.</span><span class="fu">get</span><span class="op">().</span><span class="fu">getRealDouble</span><span class="op">();</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> chart <span class="op">=</span> <span class="kw">new</span> <span class="fu">XYChartBuilder</span><span class="op">().</span><span class="fu">width</span><span class="op">(</span><span class="dv">800</span><span class="op">).</span><span class="fu">height</span><span class="op">(</span><span class="dv">600</span><span class="op">).</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>chart<span class="op">.</span><span class="fu">getStyler</span><span class="op">().</span><span class="fu">setChartTitleVisible</span><span class="op">(</span><span class="kw">false</span><span class="op">);</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>chart<span class="op">.</span><span class="fu">getStyler</span><span class="op">().</span><span class="fu">setLegendVisible</span><span class="op">(</span><span class="kw">false</span><span class="op">);</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>chart<span class="op">.</span><span class="fu">getStyler</span><span class="op">().</span><span class="fu">setChartTitleBoxBackgroundColor</span><span class="op">(</span> java<span class="op">.</span><span class="fu">awt</span><span class="op">.</span><span class="fu">Color</span><span class="op">.</span><span class="fu">white</span> <span class="op">);</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>chart<span class="op">.</span><span class="fu">getStyler</span><span class="op">().</span><span class="fu">setChartBackgroundColor</span><span class="op">(</span> java<span class="op">.</span><span class="fu">awt</span><span class="op">.</span><span class="fu">Color</span><span class="op">.</span><span class="fu">white</span> <span class="op">);</span></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> series <span class="op">=</span> chart<span class="op">.</span><span class="fu">addSeries</span><span class="op">(</span><span class="st">"function"</span><span class="op">,</span> xpts<span class="op">,</span> ypts<span class="op">);</span></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>series<span class="op">.</span><span class="fu">setMarker</span><span class="op">(</span>SeriesMarkers<span class="op">.</span><span class="fu">NONE</span><span class="op">);</span></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>BitmapEncoder<span class="op">.</span><span class="fu">getBufferedImage</span><span class="op">(</span> chart <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="22">
<div>
<figure class="figure">
<p><img src="2022-09-15-displacementFields_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="b930f771" class="cell" data-execution_count="21">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">// create the position field (1D -&gt; 2D)</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> pFieldTransition <span class="op">=</span> <span class="kw">new</span> <span class="fu">PositionFieldTransform</span><span class="op">(</span> </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> FunctionRealRandomAccessible<span class="op">&lt;&gt;(</span> <span class="dv">2</span><span class="op">,</span> </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span> p<span class="op">,</span> v <span class="op">)</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>            <span class="dt">double</span> x <span class="op">=</span> p<span class="op">.</span><span class="fu">getDoublePosition</span><span class="op">(</span> <span class="dv">0</span> <span class="op">)</span> <span class="op">-</span> <span class="dv">150</span><span class="op">;</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>            <span class="dt">double</span> y <span class="op">=</span> p<span class="op">.</span><span class="fu">getDoublePosition</span><span class="op">(</span> <span class="dv">1</span> <span class="op">)</span> <span class="op">-</span> <span class="dv">150</span><span class="op">;</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">double</span> r <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sqrt</span><span class="op">(</span> x<span class="op">*</span>x <span class="op">+</span> y<span class="op">*</span>y <span class="op">);</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>            <span class="dt">double</span> tht <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">atan2</span><span class="op">(</span> x<span class="op">,</span> y <span class="op">);</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>            v<span class="op">.</span><span class="fu">setPosition</span><span class="op">(</span> <span class="fl">2.5</span> <span class="op">*</span> r <span class="op">+</span>  <span class="dv">32</span> <span class="op">*</span> tht<span class="op">,</span> <span class="dv">0</span> <span class="op">);</span> </span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">},</span> </span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">()</span> <span class="op">-&gt;</span> <span class="op">{</span> <span class="cf">return</span> DoubleType<span class="op">.</span><span class="fu">createVector</span><span class="op">(</span> <span class="dv">1</span> <span class="op">);</span> <span class="op">}</span> <span class="op">)</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="co">// transform the image</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> imgTransformed <span class="op">=</span> <span class="fu">transformImageItvl</span><span class="op">(</span> sin1d<span class="op">,</span> pFieldTransition<span class="op">,</span> <span class="kw">new</span> <span class="fu">FinalInterval</span><span class="op">(</span> <span class="dv">256</span><span class="op">,</span> <span class="dv">256</span> <span class="op">));</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>imgTransformed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="21">
<div>
<figure class="figure">
<p><img src="2022-09-15-displacementFields_files/figure-html/cell-22-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>